### Rozhuk Ivan 2009.04 - 2013
### nginx configuration file
###


user			www www;
daemon			on;
worker_processes	2;
worker_priority		0;
pid			/var/run/nginx.pid;

master_process		on;
timer_resolution	100ms;
pcre_jit		on;


#	[ debug | info | notice | warn | error | crit ]
#error_log logs/error.log;
#error_log logs/error.log notice;
#error_log logs/error.log info;


events {
	worker_connections 65535;
	# use [ kqueue | rtsig | epoll | /dev/poll | select | poll ];
	use kqueue;
	accept_mutex on;
	accept_mutex_delay 100ms;
	multi_accept on;
}


http {
	include				mime.types;
	#default_type			application/octet-stream;
	uninitialized_variable_warn	on;

	resolver			127.0.0.1;
	resolver_timeout		8s;


	log_format			main '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" "$http_x_forwarded_for"';
	log_format			full_log '$remote_addr - $remote_user [$time_local] "$http_host" "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" "$http_x_forwarded_for"';
	#access_log			/var/log/nginx.access.log main buffer=64k;
	log_not_found			on;
	log_subrequest			off;
	open_log_file_cache		max=1000 inactive=20s valid=1m min_uses=2;

	client_body_in_file_only	off;
	client_body_in_single_buffer	off;
	#client_body_buffer_size	8k;
	client_body_temp_path		/tmp/nginx/ 1 2;
	client_body_timeout		30s;
	client_max_body_size		8m;
	client_header_timeout		30s;
	client_header_buffer_size	2k;
	large_client_header_buffers	256 64k;

	msie_padding			off;
	msie_refresh			off;

	if_modified_since		exact;

	merge_slashes			on;
	underscores_in_headers		off;
	###optimize_server_names	on;
	port_in_redirect		on;
	recursive_error_pages		off;
	chunked_transfer_encoding	off;

	server_tokens			on;
	#error_page 404			/404.html;

	sendfile			on;
	sendfile_max_chunk		64m;
	aio				off;
	read_ahead			128m;
	output_buffers  		128 64k;
	directio			off;
	tcp_nopush			on;
	tcp_nodelay			off;
	send_lowat			0;
	keepalive_timeout		65 60;
	send_timeout			60s;
	reset_timedout_connection	on;

	open_file_cache			max=1000 inactive=20s;
	open_file_cache_valid		30s;
	open_file_cache_min_uses	2;
	open_file_cache_errors		on;

	server_name_in_redirect		on;
	server_names_hash_max_size	512;
	server_names_hash_bucket_size	32;


	# GZip module
	gzip				off;
	gzip_min_length			256;
	gzip_comp_level			9;
	gzip_types			text/css text/xml application/x-javascript application/atom+xml application/rss+xml text/mathml text/plain text/vnd.sun.j2me.app-descriptor text/vnd.wap.wml text/x-component image/vnd.wap.wbmp image/x-icon image/svg+xml application/java-archive application/msword application/pdf application/postscript application/rtf application/vnd.ms-excel application/vnd.ms-powerpoint application/vnd.wap.wmlc application/vnd.wap.xhtml+xml application/x-shockwave-flash application/x-x509-ca-cert application/octet-stream audio/midi;
	gzip_http_version		1.1;
	gzip_proxied			off;
	gzip_vary			off;
	##gzip_static			off;
	#gzip_buffers			4 8k;
	#gzip_disable			regex [regex ...];

	# SSI module
	ssi 				off;
	ssi_silent_errors		off;


	server {
		listen		*:80 default_server rcvbuf=2m sndbuf=2m accept_filter=httpready so_keepalive=30m::10;
		listen		[::]:80 default_server rcvbuf=2m sndbuf=2m accept_filter=httpready so_keepalive=30m::10 ipv6only=on;
		server_name	"";

		index		index.html index.htm index.cgi index.php default.htm default.html;
		root		/usr/local/www/;
		access_log	/var/log/nginx-access.log main buffer=64k;


		# allow files listing: DataStore
		location ^~ /DataStore/ {
			root /usr/;

			send_timeout		24h;

			#allow 10.0.0.0/8;
			#allow 127.0.0.0/8;
			#allow 169.254.0.0/16;
			allow 172.16.0.0/12;
			#allow 192.168.0.0/16;
			deny all;

			access_log		off;
			autoindex		on;
			autoindex_exact_size	on;
			autoindex_localtime	on;
			add_header TransferMode.DLNA.ORG 'Streaming';
			#add_header ContentFeatures.DLNA.ORG 'DLNA.ORG_OP=11';
			# avi: add_header ContentFeatures.DLNA.ORG 'DLNA.ORG_PN=MPEG_TS_SD_NA;DLNA.ORG_OP=00;DLNA.ORG_CI=0;DLNA.ORG_FLAGS=017000 00000000000000000000000000';
			add_header ContentFeatures.DLNA.ORG 'DLNA.ORG_OP=01;DLNA.ORG_CI=0;DLNA.ORG_FLAGS=01700000000000000000000000000000';
		}

		# UPnP SUBSCRIBE/UNSUBSCRIBE handle
		location ^~ /upnp/subscribe/ {
			if ($request_method = SUBSCRIBE) {
				access_log	off;
				add_header Pragma "no-cache";
				add_header SID "uuid:7CF21CB0-2266-47BE-A608-3CC1F5210BB4";
				add_header Timeout "Second-1800";
				return 200;
			}
			if ($request_method = UNSUBSCRIBE) {
				access_log	off;
				add_header Pragma "no-cache";
				return 200;
			}
		}
		# php for: UPnP
		location ^~ /upnp/control/ {
			root /usr/local/www/;

			#allow 10.0.0.0/8;
			#allow 127.0.0.0/8;
			#allow 169.254.0.0/16;
			allow 172.16.0.0/12;
			#allow 192.168.0.0/16;
			deny all;

			access_log off;

			try_files 		$fastcgi_script_name = 404;
			include			fastcgi_params;
			#fastcgi_pass		127.0.0.1:54475;
			fastcgi_pass		unix:/var/run/php-fcgi-internal.sock;
			fastcgi_connect_timeout 30s;
			fastcgi_read_timeout	600s;
			fastcgi_send_timeout	600s;
			fastcgi_ignore_client_abort off;
			#fastcgi_cache_valid	any 10s;
			fastcgi_intercept_errors on;
			fastcgi_param		SCRIPT_FILENAME  /usr/local/www$fastcgi_script_name;
		}

		# serve static files directly
		location ~* ^.+\.(jpg|jpeg|gif|css|png|js|ico)$ {
			access_log	off;
			expires		30d;
			add_header	Last-Modified: $date_gmt;
		}

		# redirect server error pages to the static page /50x.html
		error_page 500 502 503 504  /50x.html;
		location = /50x.html {
			root	/usr/local/www/nginx-dist;
		}
	}
}
